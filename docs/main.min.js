var Tetris,game,__extends=this&&this.__extends||function(){var a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();function main(){var e=window.document.querySelector("canvas");(game=new Tetris.Game(void 0,void 0,void 0,e)).run()}!function(e){var r,t,a=-1,i="#7FFF99",o="#FF7F82",s="#464646",l="#008080",h="#A37FFF",c="#A8BEF7",u="#EEFF7F";console.log("Design & Written By CG, forward code & republish Please write clearly original author!"),console.log("Press Home button to start & pause the game, End button to stop the game."),(t=r||(r={}))[t.Started=0]="Started",t[t.Stopped=1]="Stopped",t[t.Paused=2]="Paused";var n=function(){function e(e,t,r,a){void 0===e&&(e=10),void 0===t&&(t=20),void 0===r&&(r=45),this.width=e*r,this.height=t*r,this.unit=r,this.map=new X(this.width,this.height),this.canvas=a;var n=new Audio,i=new Audio,o=new Audio,s=new Audio,l=new Audio,h=new Audio;this.sounds={bgm:[n,i,o],line_cleared:s,move:l,rotate:h},n.src="./../assets/bgm/bg1.mp3",n.loop=!0,i.src="./../assets/bgm/bg2.mp3",i.loop=!0,o.src="./../assets/bgm/bg3.mp3",o.loop=!0,s.src="./../assets/sound/lineClear.mp3",l.src="./../assets/sound/move.mp3",h.src="./../assets/sound/rotate.mp3";var c=document.querySelector("body");c.appendChild(n),c.appendChild(i),c.appendChild(o),c.appendChild(s),c.appendChild(l),c.appendChild(h),this.init()}return e.prototype.init=function(){this.score=0,this.map.empty(),this.tetromino=null,this.next=null,this.speed=550;var e=Math.floor(1e4*Math.random()%3);this.sounds.bgm[e].play(),this.state=r.Stopped},e.prototype.scale=function(e){this.width=this.width/this.unit*e,this.height=this.height/this.unit*e,this.unit=e,this.canvas.width=this.width,this.canvas.height=this.height},e.prototype.resize=function(e,t){this.width=e*this.unit,this.height=t*this.unit,this.canvas.width=this.width,this.canvas.height=this.height},e.prototype.render=function(){var t=this,a=this,n=a.canvas_2d_context;n.fillStyle="rgb(222,222,222)",n.fillRect(0,0,this.width,this.height),this.map.foreach(function(e,t,r){switch(r){case d.I:n.fillStyle=i;break;case d.J:n.fillStyle=o;break;case d.L:n.fillStyle=s;break;case d.O:n.fillStyle=l;break;case d.Z:n.fillStyle=c;break;case d.S:n.fillStyle=h;break;case d.T:n.fillStyle=u;break;default:return}n.fillRect(e*a.unit,t*a.unit,a.unit,a.unit)}),null!==this.tetromino&&this.tetromino.predict().forEach(function(e){switch(t.tetromino.type){case d.I:n.strokeStyle=i;break;case d.J:n.strokeStyle=o;break;case d.L:n.strokeStyle=s;break;case d.O:n.strokeStyle=l;break;case d.Z:n.strokeStyle=c;break;case d.S:n.strokeStyle=h;break;case d.T:n.strokeStyle=u;break;default:return}n.strokeRect(e.x,e.y,a.unit,a.unit)}),window.requestAnimationFrame(a.render.bind(a))},e.prototype.run=function(){var t=this;document.onkeydown=function(e){switch(e.key){case _.KeyHome:t.state!==r.Started?t.state=r.Started:t.state=r.Paused;break;case _.keyEnd:t.sounds.bgm.forEach(function(e){e.pause(),e.currentTime=0}),t.init();break;case _.KeyUp:t.state===r.Started&&t.tetromino.rotate()&&t.sounds.rotate.play();break;case _.KeyDown:t.state===r.Started&&50!==t.speed&&(t.speed=50,clearTimeout(t.process_id),t.process_id=setTimeout(t.process.bind(t),t.speed));break;case _.keyLeft:t.state===r.Started&&t.tetromino.move(m.LEFT)&&t.sounds.move.play();break;case _.KeyRight:t.state===r.Started&&t.tetromino.move(m.RIGHT)&&t.sounds.move.play()}},document.onkeyup=function(e){switch(e.key){case _.KeyDown:t.speed=550,clearTimeout(t.process_id),t.process_id=setTimeout(t.process.bind(t),t.speed)}},t.process_id=setTimeout(this.process.bind(this),t.speed),t.canvas.width=game.width,t.canvas.height=game.height,t.canvas_2d_context=t.canvas.getContext("2d"),null!==t.canvas_2d_context?window.requestAnimationFrame(t.render.bind(t)):console.error("Unable to initialize 2d. Your browser or machine may not support it.")},e.prototype.generate_tetromino=function(){var e=this;switch(Math.floor(1e4*Math.random()%7)){case 0:return new k(4,a,e.map);case 1:return new g(4,a,e.map);case 2:return new T(4,a,e.map);case 3:return new S(4,a,e.map);case 4:return new P(4,a,e.map);case 5:return new D(4,a,e.map);case 6:return new x(4,a,e.map)}},e.prototype.process=function(){var e=this;if(e.state===r.Started){if(null===e.tetromino||e.tetromino.state===w.Dead)switch(null!==e.tetromino&&e.tetromino.key.realY===a&&(this.sounds.bgm.forEach(function(e){e.pause(),e.currentTime=0}),alert("游戏结束！分数： "+e.score+"点击确定重新开始"),e.init(),e.state=r.Started),null===e.tetromino?e.tetromino=this.generate_tetromino():null!==e.tetromino&&null!==e.next&&(e.tetromino=e.next,e.next=this.generate_tetromino()),null===e.next&&(e.next=this.generate_tetromino()),e.next.type){case d.I:console.log("下一个： 长棍");break;case d.J:console.log("下一个： J型伞把");break;case d.L:console.log("下一个： L型伞把");break;case d.O:console.log("下一个： 方块");break;case d.Z:console.log("下一个： Z型拐爪");break;case d.S:console.log("下一个： S型拐爪");break;case d.T:console.log("下一个： T型伞把")}if(e.tetromino.move(m.DOWN),e.tetromino.state===w.Dead){var t=e.map.handle_remove_rows();if(0<t){switch(t){case 1:e.score+=10;break;case 2:e.score+=20;break;case 3:e.score+=50;break;case 4:e.score+=100;break;default:throw Error("Unusual line clear!")}e.sounds.line_cleared.play(),console.log("Score： "+e.score)}}}e.process_id=setTimeout(this.process.bind(this),e.speed)},e}();e.Game=n;var d,p,w,f,y=function(){function e(e,t){this.x=e,this.y=t}return Object.defineProperty(e.prototype,"x",{get:function(){return 45*this._x},set:function(e){this._x=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"realX",{get:function(){return this._x},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"y",{get:function(){return 45*this._y},set:function(e){this._y=e},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"realY",{get:function(){return this._y},enumerable:!0,configurable:!0}),e}();(p=d||(d={}))[p.Blank=0]="Blank",p[p.I=1]="I",p[p.J=2]="J",p[p.L=3]="L",p[p.O=4]="O",p[p.S=5]="S",p[p.Z=6]="Z",p[p.T=7]="T",(f=w||(w={}))[f.Alive=0]="Alive",f[f.Dead=1]="Dead";var m,v,X=function(){function e(e,t){this.data=[],this.width=e/45,this.length=t/45,this.empty()}return e.prototype.empty=function(){for(var e=0;e<this.length;e++){this.data[e]=[];for(var t=0;t<this.width;t++)this.data[e][t]=d.Blank}},e.prototype.set=function(e,t,r){t<0||(this.data[t][e]=r)},e.prototype.get=function(e,t){if(e<this.width&&0<=e&&t<this.length)return t<0?d.Blank:this.data[t][e];throw new Error("#101: x or y out of range!")},e.prototype.valid=function(e){return e.realX<this.width&&0<=e.realX&&e.realY<this.length},e.prototype.in_a_row=function(){for(var e=[],t=0;t<this.length;t++){for(var r=0,a=0;a<this.width;a++)this.data[t][a]===d.Blank&&r++;0===r&&e.push(t)}return e},e.prototype.handle_remove_rows=function(){var r=this,e=this.in_a_row();return 0!==e.length&&e.forEach(function(e){for(var t=0;t<10;t++)r.data[e][t]=d.Blank;for(;0<e;e--)for(t=0;t<10;t++)r.data[e][t]=r.data[e-1][t]}),e.length},e.prototype.foreach=function(e){for(var t=0;t<this.length;t++)for(var r=0;r<this.width;r++)if(!1===e(r,t,this.data[t][r]))return},e}(),Y=function(){function e(e,t,r){if(this.key=new y(4,1),this.dir=m.UP,this.state=w.Alive,this.key=new y(e,t),this.map=r,!this.can_put(this.key))throw Error("Wrong tetromino position")}return e.prototype.put_to_map=function(t){var r=this;this.body().forEach(function(e){e.realY<0||t.set(e.realX,e.realY,r.type)})},e.prototype.clear_on_map=function(t){this.body().forEach(function(e){t.set(e.realX,e.realY,d.Blank)})},e.prototype.setDir=function(e){this.clear_on_map(this.map),this.dir=e,this.put_to_map(this.map)},e.prototype.setPos=function(e){this.clear_on_map(this.map),this.key=e,this.put_to_map(this.map)},e.prototype.can_put=function(e,t){var n=this;void 0===e&&(e=this.key),void 0===t&&(t=this.dir);var i=0;return this.body(e,t).forEach(function(e){if(!n.map.valid(e)||n.map.get(e.realX,e.realY)!==d.Blank){for(var t=0,r=n.body();t<r.length;t++){var a=r[t];if(a.realX===e.realX&&a.realY===e.realY)return}i++}}),0===i},e.prototype.to_be_death=function(e){return!!(!this.map.valid(e)&&0<=e.realX&&e.realX<this.map.width||!this.can_put(e,void 0)&&this.map.valid(e))},e.prototype.move=function(e){if(this.state!==w.Dead){var t=void 0;switch(e){case m.LEFT:t=new y(this.key.realX-1,this.key.realY);break;case m.RIGHT:t=new y(this.key.realX+1,this.key.realY);break;case m.DOWN:t=new y(this.key.realX,this.key.realY+1)}if(e!==m.DOWN)return!!this.can_put(t,void 0)&&(this.setPos(t),!0);if(this.can_put(t,void 0))return this.setPos(t),!0;if(this.to_be_death(t))return this.state=w.Dead,!1}},e.prototype.rotate=function(){if(this.state!==w.Dead){var e=void 0;switch(this.dir){case m.UP:return e=m.RIGHT,!!this.can_put(void 0,e)&&(this.setDir(e),!0);case m.RIGHT:return e=m.DOWN,!!this.can_put(void 0,e)&&(this.setDir(e),!0);case m.DOWN:return e=m.LEFT,!!this.can_put(void 0,e)&&(this.setDir(e),!0);case m.LEFT:return e=m.UP,!!this.can_put(void 0,e)&&(this.setDir(e),!0)}}},e.prototype.predict=function(){for(var e=0;this.can_put(new y(this.key.realX,this.key.realY+e),void 0);)e++;return this.body(new y(this.key.realX,this.key.realY+e-1))},e}();(v=m||(m={}))[v.UP=0]="UP",v[v.RIGHT=1]="RIGHT",v[v.DOWN=2]="DOWN",v[v.LEFT=3]="LEFT";var _,b,k=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.I,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX,e.realY+2)];case m.RIGHT:return[new y(e.realX-1,e.realY),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX+2,e.realY)]}},e.prototype.rotate=function(){var e;switch(this.dir){case m.UP:if(e=m.RIGHT,this.can_put(void 0,e))return this.setDir(e),!0;break;case m.RIGHT:if(e=m.UP,this.can_put(void 0,e))return this.setDir(e),!0}return!1},e}(Y),g=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.J,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX-1,e.realY+1)];case m.RIGHT:return[new y(e.realX+1,e.realY),new y(e.realX,e.realY),new y(e.realX-1,e.realY),new y(e.realX-1,e.realY-1)];case m.DOWN:return[new y(e.realX,e.realY+1),new y(e.realX,e.realY),new y(e.realX,e.realY-1),new y(e.realX+1,e.realY-1)];case m.LEFT:return[new y(e.realX-1,e.realY),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX+1,e.realY+1)]}},e}(Y),T=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.L,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX+1,e.realY+1)];case m.RIGHT:return[new y(e.realX+1,e.realY),new y(e.realX,e.realY),new y(e.realX-1,e.realY),new y(e.realX-1,e.realY+1)];case m.DOWN:return[new y(e.realX,e.realY+1),new y(e.realX,e.realY),new y(e.realX,e.realY-1),new y(e.realX-1,e.realY-1)];case m.LEFT:return[new y(e.realX-1,e.realY),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX+1,e.realY-1)]}},e}(Y),S=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.O,a}return __extends(e,n),e.prototype.body=function(e,t){return void 0===e&&(e=this.key),void 0===t&&(t=this.dir),[new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX,e.realY+1),new y(e.realX+1,e.realY+1)]},e.prototype.rotate=function(){return!1},e}(Y),D=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.S,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX+1,e.realY+1)];case m.RIGHT:return[new y(e.realX+1,e.realY),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX-1,e.realY+1)]}},e.prototype.rotate=function(){var e;switch(this.dir){case m.UP:if(e=m.RIGHT,this.can_put(void 0,e))return this.setDir(e),!0;break;case m.RIGHT:if(e=m.UP,this.can_put(void 0,e))return this.setDir(e),!0}return!1},e}(Y),P=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.Z,a.dir=m.UP,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX-1,e.realY),new y(e.realX-1,e.realY+1)];case m.RIGHT:return[new y(e.realX+1,e.realY),new y(e.realX,e.realY),new y(e.realX,e.realY-1),new y(e.realX-1,e.realY-1)]}},e.prototype.rotate=function(){var e;switch(this.dir){case m.UP:if(e=m.RIGHT,this.can_put(void 0,e))return this.setDir(e),!0;break;case m.RIGHT:if(e=m.UP,this.can_put(void 0,e))return this.setDir(e),!0}return!1},e}(Y),x=function(n){function e(e,t,r){var a=n.call(this,e,t,r)||this;return a.type=d.T,a}return __extends(e,n),e.prototype.body=function(e,t){switch(void 0===e&&(e=this.key),void 0===t&&(t=this.dir),t){case m.UP:return[new y(e.realX-1,e.realY),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX,e.realY+1)];case m.RIGHT:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX-1,e.realY)];case m.DOWN:return[new y(e.realX-1,e.realY),new y(e.realX,e.realY),new y(e.realX+1,e.realY),new y(e.realX,e.realY-1)];case m.LEFT:return[new y(e.realX,e.realY-1),new y(e.realX,e.realY),new y(e.realX,e.realY+1),new y(e.realX+1,e.realY)]}},e}(Y);(b=_||(_={})).KeyUp="ArrowUp",b.KeyRight="ArrowRight",b.KeyDown="ArrowDown",b.keyLeft="ArrowLeft",b.keyEnd="End",b.KeyHome="Home"}(Tetris||(Tetris={})),main();